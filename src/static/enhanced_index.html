<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Intelligence System - Расширенный анализ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .search-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .search-form {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .search-options {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
        }

        .search-options h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
        }

        .search-method-options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .search-method-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-method-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .search-method-option label {
            cursor: pointer;
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }

        .search-method-description {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
        }

        .results-container {
            display: block;
        }

        .results-tabs {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Основная информация */
        .basic-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .info-card p {
            color: #666;
            line-height: 1.5;
        }

        /* Анализ веб-страниц */
        .webpage-analysis {
            margin-top: 30px;
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }

        .analysis-header h2 {
            font-size: 1.5rem;
        }

        .confidence-score {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .analysis-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
        }

        .analysis-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            width: 24px;
            height: 24px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .extracted-data {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .data-item {
            padding: 8px 12px;
            background: #e3f2fd;
            border-radius: 20px;
            display: inline-block;
            margin: 4px;
            font-size: 14px;
            color: #1976d2;
        }

        .url-analysis {
            margin-top: 20px;
        }

        .url-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #4caf50;
        }

        .url-item.failed {
            border-left-color: #f44336;
        }

        .url-item .url {
            font-weight: 600;
            color: #1976d2;
            text-decoration: none;
            display: block;
            margin-bottom: 5px;
        }

        .url-item .status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .status.success {
            background: #e8f5e8;
            color: #2e7d2e;
        }

        .status.failed {
            background: #ffebee;
            color: #c62828;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #f44336;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d2e;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #4caf50;
        }

        /* Публикации */
        .publication-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .publication-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .publication-details {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Выводы */
        .conclusions {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .conclusion-item {
            margin-bottom: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #e1e5e9;
        }

        .conclusion-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        /* Сохраненные данные */
        .saved-entry {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .saved-entry:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .saved-entry h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .saved-entry p {
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .saved-entry button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 10px;
        }

        .saved-entry button:hover {
            transform: translateY(-1px);
        }

        /* ORCID стили */
        .orcid-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #a6ce39 !important;
            text-decoration: none;
            font-weight: 600;
            padding: 6px 12px;
            background: #f8fdf3;
            border: 2px solid #a6ce39;
            border-radius: 25px;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .orcid-link:hover {
            background: #a6ce39;
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(166, 206, 57, 0.3);
        }
        
        .orcid-icon {
            width: 16px;
            height: 16px;
            background: #a6ce39;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
        }
        
        .orcid-link:hover .orcid-icon {
            background: white;
            color: #a6ce39;
        }
        
        .scientific-identifier {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .scientific-identifier strong {
            min-width: 120px;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .search-form {
                flex-direction: column;
            }

            .results-tabs {
                flex-direction: column;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }

            .basic-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📧 Email Intelligence System</h1>
            <p>Расширенный анализ email адресов с изучением веб-страниц</p>
        </div>

        <div class="search-section">
            <div class="search-form">
                <input type="email" class="search-input" id="emailInput" placeholder="Введите email адрес для анализа..." required>
                <button class="search-btn" id="searchBtn" onclick="searchEmail()">🔍 Анализ</button>
            </div>
            
            <div class="search-options">
                <h3>🔧 Настройки поиска</h3>
                <div class="search-method-options">
                    <div class="search-method-option">
                        <input type="radio" id="searchAuto" name="searchMethod" value="auto" checked>
                        <label for="searchAuto">Автоматический выбор</label>
                    </div>
                    <div class="search-method-option">
                        <input type="radio" id="searchGoogleAPI" name="searchMethod" value="google_api">
                        <label for="searchGoogleAPI">Google Search API</label>
                    </div>
                    <div class="search-method-option">
                        <input type="radio" id="searchBrowser" name="searchMethod" value="browser_search">
                        <label for="searchBrowser">Браузерный поиск</label>
                    </div>
                </div>
                <div class="search-method-description">
                    <span id="methodDescription">Система автоматически выберет лучший доступный метод поиска</span>
                </div>
            </div>
            <div class="cache-management" style="margin-top: 15px; text-align: center;">
                <button class="search-btn" onclick="clearCache()" style="margin: 5px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)">🗑️ Очистить кэш</button>
            </div>
        </div>

        <!-- Раздел результатов анализа -->
        <div class="results-section">
            <div class="results-container" id="resultsContainer">
                <div class="results-tabs">
                    <button class="tab-btn active" onclick="showTab('basic')">📋 Основная информация</button>
                    <button class="tab-btn" onclick="showTab('webpage')">🔍 Анализ веб-страниц</button>
                    <button class="tab-btn" onclick="showTab('publications')">📚 Публикации</button>
                    <button class="tab-btn" onclick="showTab('timeline')">⏰ Временная шкала</button>
                    <button class="tab-btn" onclick="showTab('networks')">🌐 Сети и связи</button>
                    <button class="tab-btn" onclick="showTab('saved')">💾 Сохраненные данные</button>
                    <button class="tab-btn" onclick="showTab('conclusions')">💡 Выводы и аналитика</button>
                </div>

                <div class="tab-content active" id="basicTab">
                    <div class="basic-info" id="basicInfo">
                        <!-- Основная информация будет загружена здесь -->
                    </div>
                </div>

                <div class="tab-content" id="webpageTab">
                    <div class="webpage-analysis" id="webpageAnalysis">
                        <!-- Анализ веб-страниц будет загружен здесь -->
                    </div>
                </div>

                <div class="tab-content" id="publicationsTab">
                    <div id="publicationsContent">
                        <!-- Публикации будут загружены здесь -->
                    </div>
                </div>

                <div class="tab-content" id="savedTab">
                    <div id="savedDataContent">
                        <!-- Сохраненные данные будут загружены здесь -->
                    </div>
                </div>

                <div class="tab-content" id="timelineTab">
                    <div id="timelineContent">
                        <!-- Временная шкала будет загружена здесь -->
                    </div>
                </div>

                <div class="tab-content" id="networksTab">
                    <div id="networksContent">
                        <!-- Сети и связи будут загружены здесь -->
                    </div>
                </div>

                <div class="tab-content" id="conclusionsTab">
                    <div class="conclusions" id="conclusionsContent">
                        <!-- Выводы будут загружены здесь -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;

        function showTab(tabName) {
            // Скрываем все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Показываем выбранную вкладку
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Загружаем сохраненные данные при первом открытии вкладки
            if (tabName === 'saved') {
                loadSavedData();
            }
        }

        async function clearCache() {
            try {
                const response = await fetch('/api/cache/clear', {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                alert(`Кэш очищен: ${result.message}`);
            } catch (error) {
                console.error('Ошибка очистки кэша:', error);
                alert('Ошибка очистки кэша: ' + error.message);
            }
        }


        async function searchEmail() {
            const emailInput = document.getElementById('emailInput');
            const searchBtn = document.getElementById('searchBtn');
            const resultsContainer = document.getElementById('resultsContainer');

            const email = emailInput.value.trim();
            if (!email) {
                alert('Пожалуйста, введите email адрес');
                return;
            }

            // Получаем выбранный метод поиска
            const selectedMethod = document.querySelector('input[name="searchMethod"]:checked').value;
            
            const endpoint = '/api/email/search';
            const loadingText = '⏳ Анализируем...';
            const originalText = '🔍 Анализ';

            // Показываем состояние загрузки
            searchBtn.disabled = true;
            searchBtn.innerHTML = loadingText;
            resultsContainer.style.display = 'block';
            
            // Показываем загрузку на всех вкладках
            showLoading();

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        email: email,
                        search_method: selectedMethod
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                currentData = data;

                // Отображаем результаты
                displayResults(data);

            } catch (error) {
                console.error('Ошибка:', error);
                showError('Произошла ошибка при выполнении поиска: ' + error.message);
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = originalText;
            }
        }

        function showLoading() {
            const loadingHtml = '<div class="loading">Анализируем данные, пожалуйста подождите...</div>';
            
            document.getElementById('basicInfo').innerHTML = loadingHtml;
            document.getElementById('webpageAnalysis').innerHTML = loadingHtml;
            document.getElementById('publicationsContent').innerHTML = loadingHtml;
            document.getElementById('timelineContent').innerHTML = loadingHtml;
            document.getElementById('networksContent').innerHTML = loadingHtml;
            document.getElementById('conclusionsContent').innerHTML = loadingHtml;
        }

        function showError(message) {
            const errorHtml = `<div class="error-message">${message}</div>`;
            
            document.getElementById('basicInfo').innerHTML = errorHtml;
            document.getElementById('webpageAnalysis').innerHTML = errorHtml;
            document.getElementById('publicationsContent').innerHTML = errorHtml;
            document.getElementById('timelineContent').innerHTML = errorHtml;
            document.getElementById('networksContent').innerHTML = errorHtml;
            document.getElementById('conclusionsContent').innerHTML = errorHtml;
        }

        function displayResults(data) {
            displayBasicInfo(data);
            displayWebpageAnalysis(data);
            displayPublications(data);
            displayTimeline(data);
            displayNetworks(data);
            displayConclusions(data);
        }

        async function loadSavedData() {
            const savedDataContainer = document.getElementById('savedDataContent');
            savedDataContainer.innerHTML = 'Загрузка сохраненных данных...';

            try {
                const response = await fetch('/api/email/history?page=1&limit=10');
                if (!response.ok) {
                    throw new Error(`Ошибка HTTP: ${response.status}`);
                }

                const data = await response.json();
                renderSavedData(data.results);
                savedDataContainer.dataset.loaded = 'true';

            } catch (error) {
                console.error('Ошибка при загрузке сохраненных данных:', error);
                savedDataContainer.innerHTML = 'Ошибка загрузки данных. Попробуйте позже.';
            }
        }

        function renderSavedData(results) {
            const savedDataContainer = document.getElementById('savedDataContent');
            if (results.length === 0) {
                savedDataContainer.innerHTML = 'Нет сохраненных данных для отображения.';
                return;
            }

            const html = results.map((entry, index) => `
                <div class="saved-entry">
                    <h3>${entry.email}</h3>
                    <p>Дата создания: ${new Date(entry.created_at).toLocaleString()}</p>
                    <p>Последнее обновление: ${new Date(entry.updated_at).toLocaleString()}</p>
                    <p>Количество обращений: ${entry.hit_count}</p>
                    <p>Метод поиска: ${entry.search_method}</p>
                    <button onclick="viewSavedData(${index})">Посмотреть данные</button>
                </div>
            `).join('');
            
            // Сохраняем данные для последующего использования
            window.savedDataResults = results;

            savedDataContainer.innerHTML = html;
        }

        function viewSavedData(index) {
            if (window.savedDataResults && window.savedDataResults[index]) {
                currentData = window.savedDataResults[index].data;
                displayResults(currentData);
                showTab('basic');
            } else {
                alert('Ошибка загрузки данных');
            }
        }

        function displayBasicInfo(data) {
            const basicInfo = data.basic_info || {};
            const professionalInfo = data.professional_info || {};
            const scientificIds = data.scientific_identifiers || {};

            const html = `
                <div class="info-card">
                    <h3>👤 Владелец Email</h3>
                    <p><strong>Имя:</strong> ${basicInfo.owner_name || 'Не определено'}</p>
                    <p><strong>Английское имя:</strong> ${basicInfo.owner_name_en || 'Not determined'}</p>
                    <p><strong>Статус:</strong> ${getStatusText(basicInfo.status)}</p>
                    ${basicInfo.confidence_score ? `<p><strong>Уверенность:</strong> ${Math.round(basicInfo.confidence_score * 100)}%</p>` : ''}
                </div>
                
                <div class="info-card">
                    <h3>💼 Профессиональная информация</h3>
                    <p><strong>Должность:</strong> ${professionalInfo.position || 'Не определено'}</p>
                    <p><strong>Место работы:</strong> ${professionalInfo.workplace || 'Не определено'}</p>
                    <p><strong>Адрес:</strong> ${professionalInfo.address || 'Не определено'}</p>
                    <p><strong>Специализация:</strong> ${professionalInfo.specialization || 'Не определено'}</p>
                    ${professionalInfo.degrees ? `<p><strong>Степени:</strong> ${professionalInfo.degrees.join(', ')}</p>` : ''}
                </div>
                
                <div class="info-card">
                    <h3>🔬 Научные идентификаторы</h3>
                    <div class="scientific-identifier">
                        <strong>ORCID ID:</strong>
                        ${scientificIds.orcid_id ? `
                            <a href="https://orcid.org/${scientificIds.orcid_id}" target="_blank" rel="noopener noreferrer" class="orcid-link">
                                <span class="orcid-icon">ID</span>
                                ${scientificIds.orcid_id}
                            </a>
                        ` : '<span style="color: #999;">Не найден</span>'}
                    </div>
                    <p><strong>SPIN код:</strong> ${scientificIds.spin_code || 'Не найден'}</p>
                    <p><strong>Email для корреспонденции:</strong> ${scientificIds.email_for_correspondence || 'Не определен'}</p>
                    ${scientificIds.alternative_emails ? `<p><strong>Альтернативные email:</strong> ${scientificIds.alternative_emails.join(', ')}</p>` : ''}
                </div>
                
                <div class="info-card">
                    <h3>📊 Метаданные поиска</h3>
                    <p><strong>Найдено результатов:</strong> ${data.search_metadata?.results_count || 0}</p>
                    <p><strong>Метод поиска:</strong> ${getSearchMethodText(data.search_metadata?.search_method)}</p>
                    <p><strong>Статус:</strong> ${data.search_metadata?.status || 'unknown'}</p>
                    <p><strong>Источники:</strong> ${data.information_sources?.length || 0} источников</p>
                </div>
            `;

            document.getElementById('basicInfo').innerHTML = html;
        }

        function displayWebpageAnalysis(data) {
            const webpageAnalysis = data.webpage_analysis;
            
            if (!webpageAnalysis) {
                document.getElementById('webpageAnalysis').innerHTML = `
                    <div class="error-message">
                        Анализ веб-страниц недоступен. Возможные причины:
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            <li>Используется кэшированный результат</li>
                            <li>Анализатор веб-страниц отключен</li>
                            <li>Не найдено подходящих ссылок для анализа</li>
                        </ul>
                    </div>
                `;
                return;
            }

            const ownerData = webpageAnalysis.owner_identification || {};
            const professionalData = webpageAnalysis.professional_details || {};
            const contactData = webpageAnalysis.contact_information || {};
            const academicData = webpageAnalysis.academic_info || {};
            const metaData = webpageAnalysis.analysis_metadata || {};

            const html = `
                <div class="analysis-header">
                    <h2>🔍 Анализ веб-страниц</h2>
                    <div class="confidence-score">
                        Уверенность: ${Math.round((ownerData.confidence_score || 0) * 100)}%
                    </div>
                </div>

                <div class="analysis-grid">
                    <div class="analysis-section">
                        <h3><span class="section-icon">👤</span>Идентификация владельца</h3>
                        <div class="extracted-data">
                            <p><strong>Наиболее вероятное имя:</strong> ${ownerData.most_likely_name || 'Не определено'}</p>
                            <p><strong>Найдено имен:</strong> ${ownerData.names_found?.length || 0}</p>
                            ${ownerData.name_variations?.length ? `
                                <p><strong>Вариации имен:</strong></p>
                                <div>
                                    ${ownerData.name_variations.map(name => `<span class="data-item">${name}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="analysis-section">
                        <h3><span class="section-icon">💼</span>Профессиональные данные</h3>
                        <div class="extracted-data">
                            ${professionalData.positions?.length ? `
                                <p><strong>Должности:</strong></p>
                                <div>
                                    ${professionalData.positions.map(pos => `<span class="data-item">${pos}</span>`).join('')}
                                </div>
                            ` : '<p>Должности не найдены</p>'}
                            
                            ${professionalData.organizations?.length ? `
                                <p><strong>Организации:</strong></p>
                                <div>
                                    ${professionalData.organizations.map(org => `<span class="data-item">${org}</span>`).join('')}
                                </div>
                            ` : '<p>Организации не найдены</p>'}
                            
                            ${professionalData.locations?.length ? `
                                <p><strong>Локации:</strong></p>
                                <div>
                                    ${professionalData.locations.map(loc => `<span class="data-item">${loc}</span>`).join('')}
                                </div>
                            ` : '<p>Локации не найдены</p>'}
                        </div>
                    </div>

                    <div class="analysis-section">
                        <h3><span class="section-icon">📞</span>Контактная информация</h3>
                        <div class="extracted-data">
                            ${contactData.emails?.length ? `
                                <p><strong>Email адреса:</strong></p>
                                <div>
                                    ${contactData.emails.map(email => `<span class="data-item">${email}</span>`).join('')}
                                </div>
                            ` : '<p>Дополнительные email не найдены</p>'}
                            
                            ${contactData.phones?.length ? `
                                <p><strong>Телефоны:</strong></p>
                                <div>
                                    ${contactData.phones.map(phone => `<span class="data-item">${phone}</span>`).join('')}
                                </div>
                            ` : '<p>Телефоны не найдены</p>'}
                        </div>
                    </div>

                    <div class="analysis-section">
                        <h3><span class="section-icon">🎓</span>Академическая информация</h3>
                        <div class="extracted-data">
                            ${academicData.degrees?.length ? `
                                <p><strong>Ученые степени:</strong></p>
                                <div>
                                    ${academicData.degrees.map(degree => `<span class="data-item">${degree}</span>`).join('')}
                                </div>
                            ` : '<p>Ученые степени не найдены</p>'}
                            
                            ${academicData.research_areas?.length ? `
                                <p><strong>Области исследований:</strong></p>
                                <div>
                                    ${academicData.research_areas.slice(0, 5).map(area => `<span class="data-item">${area}</span>`).join('')}
                                </div>
                            ` : '<p>Области исследований не найдены</p>'}
                        </div>
                    </div>
                </div>

                <div class="url-analysis">
                    <h3>🌐 Анализ URL адресов</h3>
                    <p style="margin-bottom: 15px; color: #666;">
                        Успешно проанализировано: <strong>${metaData.successful_extractions || 0}</strong> из <strong>${metaData.analyzed_urls?.length || 0}</strong> страниц
                    </p>
                    
                    ${metaData.analyzed_urls?.length ? metaData.analyzed_urls.map(urlData => `
                        <div class="url-item ${urlData.status === 'success' ? 'success' : 'failed'}">
                            <a href="${urlData.url}" target="_blank" class="url">${urlData.url}</a>
                            <span class="status ${urlData.status}">${getUrlStatusText(urlData.status)}</span>
                            ${urlData.extracted_data_types ? `
                                <div style="margin-top: 8px;">
                                    <small><strong>Извлечены данные:</strong> ${urlData.extracted_data_types.join(', ')}</small>
                                </div>
                            ` : ''}
                            ${urlData.reason ? `
                                <div style="margin-top: 8px;">
                                    <small><strong>Причина:</strong> ${urlData.reason}</small>
                                </div>
                            ` : ''}
                        </div>
                    `).join('') : '<p>Нет данных об анализе URL</p>'}
                </div>
            `;

            document.getElementById('webpageAnalysis').innerHTML = html;
        }

        function displayPublications(data) {
            const publications = data.publications || [];
            
            if (publications.length === 0) {
                document.getElementById('publicationsContent').innerHTML = `
                    <div class="error-message">
                        Публикации не найдены или не удалось их извлечь из анализируемых источников.
                    </div>
                `;
                return;
            }

            const html = publications.map(pub => `
                <div class="publication-item">
                    <div class="publication-title">${pub.title || 'Без названия'}</div>
                    <div class="publication-details">
                        <p><strong>Авторы:</strong> ${pub.authors || 'Не указаны'}</p>
                        <p><strong>Журнал:</strong> ${pub.journal || 'Не указан'}</p>
                        <p><strong>Год:</strong> ${pub.year || 'Не указан'}</p>
                        <p><strong>DOI:</strong> ${pub.doi || 'Не найден'}</p>
                        ${pub.url ? `<p><strong>URL:</strong> <a href="${pub.url}" target="_blank">${pub.url}</a></p>` : ''}
                    </div>
                </div>
            `).join('');

            document.getElementById('publicationsContent').innerHTML = html;
        }

        function displayTimeline(data) {
            const publications = data.publications || [];
            const searchMetadata = data.search_metadata || {};
            const basicInfo = data.basic_info || {};
            
            let timelineEvents = [];
            
            // Добавляем публикации в timeline
            publications.forEach(pub => {
                if (pub.year) {
                    timelineEvents.push({
                        year: parseInt(pub.year),
                        type: 'publication',
                        title: pub.title || 'Публикация без названия',
                        description: `Журнал: ${pub.journal || 'Не указан'}`,
                        authors: pub.authors || 'Авторы не указаны'
                    });
                }
            });
            
            // Добавляем текущий поиск
            if (searchMetadata.timestamp) {
                timelineEvents.push({
                    year: new Date(searchMetadata.timestamp * 1000).getFullYear(),
                    type: 'search',
                    title: 'Анализ данных',
                    description: `Найдено ${searchMetadata.results_count || 0} результатов`
                });
            }
            
            // Сортируем по годам
            timelineEvents.sort((a, b) => b.year - a.year);
            
            if (timelineEvents.length === 0) {
                document.getElementById('timelineContent').innerHTML = `
                    <div class="error-message">
                        Недостаточно данных для построения временной шкалы.
                        Добавьте информацию о публикациях или деятельности.
                    </div>
                `;
                return;
            }
            
            const html = `
                <h3>⏰ Временная шкала активности</h3>
                <div class="timeline-container" style="margin-top: 20px;">
                    ${timelineEvents.map(event => `
                        <div class="timeline-item" style="
                            background: #f8f9fa;
                            padding: 20px;
                            border-radius: 10px;
                            margin-bottom: 15px;
                            border-left: 4px solid ${event.type === 'publication' ? '#667eea' : '#4caf50'};
                        ">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 8px 0; color: #333;">
                                        ${event.type === 'publication' ? '📚' : '🔍'} ${event.title}
                                    </h4>
                                    <p style="margin: 0 0 5px 0; color: #666; font-size: 14px;">${event.description}</p>
                                    ${event.authors ? `<p style="margin: 0; color: #888; font-size: 12px;">Авторы: ${event.authors}</p>` : ''}
                                </div>
                                <div style="
                                    background: ${event.type === 'publication' ? '#667eea' : '#4caf50'};
                                    color: white;
                                    padding: 8px 12px;
                                    border-radius: 20px;
                                    font-weight: 600;
                                    font-size: 14px;
                                    min-width: 60px;
                                    text-align: center;
                                ">
                                    ${event.year}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('timelineContent').innerHTML = html;
        }
        
        function displayNetworks(data) {
            const contactInfo = data.webpage_analysis?.contact_information || {};
            const professionalInfo = data.professional_info || {};
            const scientificIds = data.scientific_identifiers || {};
            const basicInfo = data.basic_info || {};
            
            let networks = [];
            
            // Email сети
            if (contactInfo.emails && contactInfo.emails.length > 0) {
                networks.push({
                    type: 'email',
                    title: 'Email адреса',
                    items: contactInfo.emails,
                    icon: '📧'
                });
            }
            
            // Научные сети
            if (scientificIds.orcid_id && scientificIds.orcid_id !== 'Не найден') {
                networks.push({
                    type: 'scientific',
                    title: 'ORCID',
                    items: [scientificIds.orcid_id],
                    icon: '🔬',
                    links: [`https://orcid.org/${scientificIds.orcid_id}`]
                });
            }
            
            // Организационные связи
            if (professionalInfo.workplace && professionalInfo.workplace !== 'Не определено') {
                networks.push({
                    type: 'organization',
                    title: 'Организация',
                    items: [professionalInfo.workplace],
                    icon: '🏢'
                });
            }
            
            // Сайты и профили
            if (contactInfo.websites && contactInfo.websites.length > 0) {
                networks.push({
                    type: 'web',
                    title: 'Веб-присутствие',
                    items: contactInfo.websites,
                    icon: '🌐',
                    links: contactInfo.websites
                });
            }
            
            if (networks.length === 0) {
                document.getElementById('networksContent').innerHTML = `
                    <div class="error-message">
                        Сетевые связи не обнаружены. 
                        Для построения карты связей необходимо больше информации о контактах и профилях.
                    </div>
                `;
                return;
            }
            
            const html = `
                <h3>🌐 Сети и связи</h3>
                <div class="networks-grid" style="
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    gap: 20px;
                    margin-top: 20px;
                ">
                    ${networks.map(network => `
                        <div class="network-item" style="
                            background: #f8f9fa;
                            padding: 20px;
                            border-radius: 10px;
                            border-left: 4px solid #667eea;
                        ">
                            <h4 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 20px;">${network.icon}</span>
                                ${network.title}
                            </h4>
                            <div class="network-items">
                                ${network.items.map((item, index) => {
                                    const link = network.links && network.links[index];
                                    return `
                                        <div style="
                                            background: white;
                                            padding: 10px 15px;
                                            border-radius: 8px;
                                            margin-bottom: 8px;
                                            border: 1px solid #e1e5e9;
                                        ">
                                            ${link ? 
                                                `<a href="${link}" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 500;">${item}</a>` : 
                                                `<span style="color: #333; font-weight: 500;">${item}</span>`
                                            }
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                ${networks.length > 1 ? `
                    <div style="
                        margin-top: 30px;
                        padding: 20px;
                        background: #e3f2fd;
                        border-radius: 10px;
                        border-left: 4px solid #2196f3;
                    ">
                        <h4 style="margin: 0 0 10px 0; color: #1976d2;">📊 Анализ связей</h4>
                        <p style="margin: 0; color: #1976d2; font-size: 14px;">
                            Обнаружено <strong>${networks.length}</strong> типов сетевых связей. 
                            Это указывает на ${networks.length >= 3 ? 'высокую' : networks.length >= 2 ? 'среднюю' : 'низкую'} 
                            степень цифрового присутствия.
                        </p>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('networksContent').innerHTML = html;
        }
        
        function displayConclusions(data) {
            const conclusions = data.conclusions || [];
            const researchInterests = data.research_interests || [];
            const searchMetadata = data.search_metadata || {};
            const informationSources = data.information_sources || [];

            let html = '';

            if (conclusions.length > 0) {
                html += '<h3>💡 Основные выводы</h3>';
                conclusions.forEach(conclusion => {
                    html += `<div class="conclusion-item">• ${conclusion}</div>`;
                });
            }

            if (researchInterests.length > 0) {
                html += '<h3 style="margin-top: 30px;">🔬 Области научных интересов</h3>';
                html += '<div style="margin-top: 15px;">';
                researchInterests.forEach(interest => {
                    html += `<span class="data-item">${interest}</span>`;
                });
                html += '</div>';
            }
            
            // Добавляем аналитику
            html += '<h3 style="margin-top: 30px;">📊 Аналитика поиска</h3>';
            html += `
                <div style="
                    background: #f0f8ff;
                    padding: 20px;
                    border-radius: 10px;
                    border-left: 4px solid #667eea;
                    margin-top: 15px;
                ">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Результатов найдено:</strong><br>
                            <span style="font-size: 24px; color: #667eea;">${searchMetadata.results_count || 0}</span>
                        </div>
                        <div>
                            <strong>Источников данных:</strong><br>
                            <span style="font-size: 24px; color: #4caf50;">${informationSources.length || 0}</span>
                        </div>
                        <div>
                            <strong>Метод поиска:</strong><br>
                            <span style="font-size: 14px; color: #666;">${getSearchMethodText(searchMetadata.search_method)}</span>
                        </div>
                        <div>
                            <strong>Время анализа:</strong><br>
                            <span style="font-size: 14px; color: #666;">
                                ${searchMetadata.timestamp ? new Date(searchMetadata.timestamp * 1000).toLocaleString('ru-RU') : 'Неизвестно'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            if (informationSources.length > 0) {
                html += '<h4 style="margin-top: 25px;">📋 Источники информации</h4>';
                html += '<div style="margin-top: 15px;">';
                informationSources.forEach(source => {
                    html += `<span class="data-item" style="background: #e8f5e8; color: #2e7d2e;">${source}</span>`;
                });
                html += '</div>';
            }

            if (conclusions.length === 0 && researchInterests.length === 0) {
                html = '<div class="error-message">Выводы и научные интересы не определены.</div>';
            }

            document.getElementById('conclusionsContent').innerHTML = html;
        }

        function getStatusText(status) {
            const statusMap = {
                'identified': '✅ Идентифицирован',
                'partial_info': '⚠️ Частичная информация',
                'not_found': '❌ Не найден',
                'limited_search': '🔍 Ограниченный поиск',
                'educational_domain': '🎓 Образовательный домен',
                'government_domain': '🏛️ Государственный домен'
            };
            return statusMap[status] || status || 'Неизвестно';
        }

        function getSearchMethodText(method) {
            const methodMap = {
                'real_api': '🔗 API поисковых систем',
                'alternative': '🔄 Альтернативный поиск',
                'fallback': '⚡ Резервный режим',
                'cache': '💾 Кэш',
                'demo': '🎭 Демо режим'
            };
            return methodMap[method] || method || 'Неизвестно';
        }

        function getUrlStatusText(status) {
            const statusMap = {
                'success': '✅ Успешно',
                'failed': '❌ Неудачно',
                'error': '⚠️ Ошибка'
            };
            return statusMap[status] || status || 'Неизвестно';
        }

        // Обработка нажатия Enter в поле ввода
        document.getElementById('emailInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchEmail();
            }
        });

        // Автофокус на поле ввода
        document.getElementById('emailInput').focus();

        // Обработчики для методов поиска
        function updateMethodDescription(method) {
            const descriptions = {
                'auto': 'Система автоматически выберет лучший доступный метод поиска',
                'google_api': 'Использовать Google Custom Search API для поиска (быстро, точно)',
                'browser_search': 'Использовать браузерный поиск через Selenium (медленно, но обходит ограничения)'
            };
            
            document.getElementById('methodDescription').textContent = descriptions[method] || descriptions['auto'];
        }

        // Добавляем обработчики изменения радиокнопок
        document.querySelectorAll('input[name="searchMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                updateMethodDescription(this.value);
            });
        });
    </script>
</body>
</html>
